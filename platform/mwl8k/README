Introduction
============

The mwl8k is a reference Access Point platform from Marvell.  This document
describes where the source comes from, how to bring the target up, etc.  I do
all of my work from the location of this README.  So any reference to files,
patches, etc. are usually with respect to this directory if not otherwise
mentioned.

Development Machine Setup
=========================

These instructions were developed using Ubuntu 10.04:

1. Get a suitable uclibc toolchain (armv5tel).  I use code sourcery's
   arm-none-eabi-gcc (Sourcery G++ Lite 2009q3-68) 4.4.1.

2. Set up a tftp server somewhere.  I use my own development machine, and the
   tftp root directory happens to be /srv/tftp.  Make sure the permissions are
   sufficiently liberal.

3. Set up an nfs server somewhere.  I use my own development machine for this
   too.  I export my

4. Ensure you have the u-boot utility "mkimage" available in your path
   somewhere.

5. Set up your environment:

   $ export PATH=$PATH:/path/to/CodeSourcery/Sourcery_G++_Lite/bin
   $ export CROSS_COMPILE=arm-uclinuxeabi-
   $ export ARCH=arm
   $ export TFTPROOT=/srv/tftp/
   $ export ROOTDIR=/path/to/your/nfs/roots/install_root
   [ see "Preparing the rootfs" for more details on this ]

Preparing the rootfs
====================

1. Install the baseline fs from Marvell.  This comes with the
   mwl8k-quick-start.zip package from Marvell.

   $ cd /where/you/put/your/nfsroots
   $ sudo tar xzf /path/to/mwl8k-quick-start/install_root.tgz
   [ The tarball contains device nodes.  So you have to be root. ]

2. Change the inittab to start a shell instead of the login:

   $ cat ./install_root/etc/inittab
   ttyS0::restart:/sbin/init
   ::sysinit:/etc/init.sh
   ttyS0::respawn:/bin/sh

3. Make a default wifi interface come up:

   $ echo "iw phy phy0 interface add wlan0 type __ap" >> ./install_root/etc/inittab

Building the Kernel
===================

0. Make sure your environment variables are set!

1. Get the source:

   $ git clone git://git.kernel.org/pub/scm/linux/kernel/git/linville/wireless-testing.git
   $ cd wireless-testing

2. Patch the source:

   $ git am ../patches/000*

3. Configure, build, and deploy the kernel:

   $ cp ../config_mwl8k ./.config
   $ make uImage
   $ cp arch/arm/boot/uImage $TFTPROOT

Setup the Target
================

I connect the WAN port of the mwl8k to my dev machine via a crossover cable,
and I get a console on the serial port.  I set up my u-boot environment like
this for network booting (based on Marvell uboot.txt and altered for my env.):

setenv ipaddr 192.168.6.1
setenv serverip 192.168.6.2
setenv x_bootargs console='ttyS0,115200 mtdparts=spi0.0:512k(uboot),512k@512k(psm),3m@1m(kernel),12m@4m(rootfs)'
setenv x_bootcmd 'protect off g0xf8000000 +1; $(x_bootcmd_kernel); setenv bootargs $(x_bootargs) $(x_bootargs_root); bootm 0x6400000'
setenv x_bootcmd_kernel tftp 0x6400000 /srv/tftp/uImage
setenv x_bootargs_root root=/dev/nfs rw nfsroot=192.168.6.2:/path/to/nfs/install_root ip=dhcp
setenv bootcmd $(x_bootcmd)
saveenv

TODO: These instructions require a dhcp server up on the dev host.  Surely we
can eliminate that!

If you ever want to change back to booting from flash:

setenv bootcmd 'fsload 0x6400000 uImage;setenv bootargs $(y_bootargs) $(y_bootargs_root) ip=$(ipaddr):$(serverip)$(bootargs_end); bootm 0x6400000;'
saveenv

Other Notes
===========

-- Need to grab a file from the device real quick?  Use the built-in http server:

   Device $ httpd -p 8080 -h /

   Dev Host $ wget 192.168.6.1:8080/path/to/file

-- openocd kinda works.  I use the olimex/USB adapter and I pretend the mwl8k
   is a sheeva plug.  This is what my openocd.cfg looks like:

   source [find interface/olimex-arm-usb-ocd.cfg]
   source [find target/feroceon.cfg]
   source [find board/sheevaplug.cfg]

References
==========

[1] Marvell's bring-up guide: 3x3ap_mwl8k_quickstart_guide.doc.  It assumes you
have a Fedora machine.

[2] Many details/files/etc. from this document came from the
mwl8k-quick-start.zip from the Marvell Extranet.
